---
date: "2019-12-18T00:00:00+09:00"
title: "新機能・クラッシュ後の自動復帰！"
categories:
  - "作品紹介"
tags:
  - "マイクロマウス"
  - "KERISE"
draft: true
---

この記事は，[Micro Mouse Advent Calendar](https://adventar.org/calendars/4007) 18日目の記事です．

昨日の記事は mako さんの機体紹介でした．  
<!-- 感想を書く -->

## はじめに

こんにちは．けりです．

今回の記事では，  
私のマイクロマウス [KERISE v4](/posts/2018-05-03-kerise-v4-coming) に搭載されている  
新機能「**クラッシュ後の自動復帰**」を紹介します．

<!--more-->

{{< postfig src="kerisev4.jpg" title="KERISE v4" width="240px" link="kerisev4.jpg" >}}

### 目指すは自律賞

マイクロマウス競技には，「自律賞」という賞があります．  
現行の競技規定では次のように記されています．

> [自律賞](https://www.ntf.or.jp/mouse/rule/hyouka_micro-JA.html): 持ち時間内に全走行が完了（最後にスタート地点まで戻る）するまで、ノータッチで走り切ったマイクロマウスの内、最短走行時間を記録したマイクロマウスに対する評価

つまり，競技の全行程を**完全自律**で終えるというものです．

### 32x32迷路での完全自律マウスはまだいない

実は，過去のマイクロマウス競技では，自律賞を獲得したマウスが毎年存在しました．  
しかし，ここ数年で自律賞を獲得したマウスはありません．

その理由は，競技ルールの改正があったからです．  
2015年までは，自律賞の規定は次のようになっていました．

> [自律賞(2015年まで)](http://www.ntf.or.jp/mouse/micromouse2015/hyouka_half.html): 1回目のスタートから持ち時間内に全走行が完了(最後にスタート地点まで戻る)するまで、ノータッチで走り切ったマウスの内、最短走行時間を記録したマウスに対する評価。**全走行を完了したマウスがない場合は、最初にタッチした時までの最短完走時間を記録したマウスを評価**する。

以前のルールでは，最後に追加の1文がありました．  
たとえ探索走行だったとしても，1回でもゴールに達したマウスがいれば**必ず受賞者が現れる**というルールでした．

それが，2016年からは，以下の規定の**ベストマウサー**という賞が追加されて，
自律賞は，**完全自律マウス**に限定されました．

> [自律賞(2016年より)](https://www.ntf.or.jp/mouse/rule/hyouka_micro-JA.html): 持ち時間内に全走行が完了（最後にスタート地点まで戻る）するまで、ノータッチで走り切ったマイクロマウスの内、最短走行時間を記録したマイクロマウスに対する評価  
> [ベストマウサー(2016年より)](http://www.ntf.or.jp/mouse/rule/hyouka_micro-JA.html): １回目のスタートから最初に操作者がロボットに触れた時までの最短完走時間を記録したマイクロマウスを評価する  

この**ルール改正後に自律賞を獲得したマウスはまだ存在しない**のです．  
僕はこの賞を目指しています！！

### 完全自律マウスの課題

現行の自律賞，つまり完全自律走行を達成するためには，

- 制限時間内に全行程を終えるための時間管理
- 状況に応じた走行パラメータの自動選択
- タイヤのホコリ耐性
- **絶対にクラッシュしない**

が必要となります．

### 最短記録と自律走行のトレードオフ

上記で挙げた**絶対にクラッシュしない**という条件ですが，これはかなり困難な条件です．

なぜなら，マイクロマウスは走行時間を競う競技なので，
いい記録を残すためには**クラッシュするギリギリ**を攻めなければなりません．

最短走行の記録と自律走行にはトレードオフがあるのです．

### 新機能・自動復帰による解決

そんな困難な**完全自律走行**ですが，別の視点の攻略法があります．

それが今回紹介する**クラッシュ後に自動復するマウス**です！

おそらく今までに自動復帰するマウスを作りたいと考えた人は少なくないと思います．  
ただ，実装がかなり複雑で，実現した人はいませんでした．

僕は**約1年半前**から取り組み始め，遂に今年，**自動復帰マウス**を実現しました！

## 自動復帰の流れ

最短走行でクラッシュしてしまったとき，次の要領で自動復帰して走行に戻ります．

1. 前壁補正などを用いて．位置と姿勢を整える
2. 周辺の数区画を探索して，既知の迷路と比較をする
3. 自己位置が一意に定まるまで周辺区画の探索を続ける
4. 自己位置が確定したら，リタイアにならないようにゴール区画へ行く
5. スタート区画に戻り，次の最短走行を行う

### 動画

(動画)

## 自己位置同定のアルゴリズム

- 新たな迷路情報を用意して，周辺のマスを探索する
- 32x32マスのズレと東西南北4方向の回転に対してパターンマッチングする
- 未知の壁は無視して，既知の食い違いを数えます．

## 自己位置同定の精度

## 難しかった点

### クラッシュ後に区画の中央まで復帰

櫛や密林などの壁が少ない場所での復帰は前壁補正による復帰が難しいという問題がありました．

そこで，ToF測距センサで周辺を操作して平らな壁を探しました．

(動画)

### 区画位置と回転方向を特定する必要がある

### 自己位置同定中にスタート区画に訪問するとまずい

## おわりに
